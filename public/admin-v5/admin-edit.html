<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" type="text/css" href="./assets/lib/bootstrap/css/bootstrap.min.css" />
	<link rel="stylesheet" href="./assets/iconfonts/bootstrap-icons.css">
	<link rel="stylesheet" href="./assets/lib/Validform/css/style.css">
	<!-- 图片上传--组件 -->
	<link rel="stylesheet" href="./assets/css/upload.css">

	<link rel="stylesheet" type="text/css" href="./assets/css/style.css" />
	<title>管理员编辑</title>
</head>

<body>
	<!-- 导航 -->
	<header></header>
	<div class="container-fluid pt-3">
		<div class="row">
			<!-- 侧边栏 -->
			<div id="left-menu" class="col-2 p-0"></div>
			<!-- 内容 -->
			<div class="col-10">
				<div class="card shadow-sm">
					<div class="card-header">
						管理员编辑
					</div>
					<div class="card-body">
						<form id="form" action="/admin/info">
							<!-- 管理员id--隐藏表单 -->
							<input type="hidden" name="id" value="">
							<div class="mb-3 row">
								<label class="col-sm-2 col-form-label">用户名</label>
								<div class="col-sm-10">
									<input datatype="s3-15" name="username" readonly type="text" class="form-control">
								</div>
							</div>
							<div class="mb-3 row">
								<label class="col-sm-2 col-form-label">姓名</label>
								<div class="col-sm-10">
									<input datatype="s2-20" errormsg="姓名至少2个字符，最多20个字符" name="fullname" type="text"
										class="form-control">
								</div>
							</div>
							<div class="mb-3 row align-items-center">
								<label class="col-sm-2 col-form-label">性别</label>
								<div class="col-sm-10">
									<div class="form-check form-check-inline">
										<label class="form-check-label">
											<input class="form-check-input" type="radio" name="sex" value="男"> 男
										</label>
									</div>
									<div class="form-check form-check-inline">
										<label class="form-check-label">
											<input class="form-check-input" datatype="*" type="radio" name="sex"
												value="女"> 女
										</label>
									</div>
								</div>
							</div>
							<div class="mb-3 row">
								<label class="col-sm-2 col-form-label">角色</label>
								<div class="col-sm-10">
									<select datatype="*" name="role" class="form-select">
									</select>
								</div>
							</div>
							<div class="mb-3 row">
								<label class="col-sm-2 col-form-label">手机</label>
								<div class="col-sm-10">
									<input datatype="m" name="tel" type="text" class="form-control">
								</div>
							</div>
							<div class="mb-3 row">
								<label class="col-sm-2 col-form-label">邮箱</label>
								<div class="col-sm-10">
									<input datatype="e" name="email" type="text" class="form-control">
								</div>
							</div>
							<div class="mb-3 row">
								<label class="col-sm-2 col-form-label">头像</label>
								<div class="col-sm-10">
									<div class="upload-box uploaded">
										<div class="plus text-black-50">
											<i class="bi bi-plus-lg fs-3"></i>
											<input type="file" class="file">
										</div>
										<img src="" class="photo">
										<div class="cover text-white">
											<i class="bi bi-x-lg fs-3 remove"></i>
										</div>
									</div>
									<!-- 隐藏表单 -->
									<input datatype="*" nullmsg="请上传一张头像！" name="avatar" type="hidden" value="">
								</div>
							</div>
							<div class="mb-3 row">
								<div class="col-sm-10 offset-sm-2">
									<button type="submit" class="btn btn-primary">保存修改</button>
								</div>
							</div>
						</form>
					</div>

				</div>
			</div>
		</div>
	</div>
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="./assets/lib/jQuery/jquery-3.6.0.min.js"></script>
	<script src="./assets/lib/bootstrap/js/bootstrap.min.js"></script>
	<script src="./assets/lib/layer/layer.js"></script>
	<script src="./assets/lib/Validform/js/Validform_v5.3.2_min.js"></script>
	<!-- 公共layout -->
	<script src="./assets/js/layout.js"></script>
	<!-- 身份认证 -->
	<script src="./assets/js/auth.js"></script>
	<!-- 工具类函数 -->
	<script src="./assets/js/public.js"></script>
	<script>
		// 表单验证--保存资料
		$('#form').Validform({
			ajaxPost: true,
			tiptype: 4,
			callback: function (res) {
				if (res.status) {
					layer.msg(res.msg, { icon: 1 });
					// 重定向
					location.replace('./admin-list.html');
				} else {
					layer.msg(res.msg, { icon: 5 });
				}
			}
		});
	</script>
	<script>
		// 获取参数，赋值隐藏表单域，以备修改资料的参数id
		var id = params('id');
		$('input[name=id]').val(id);
		// 获取角色列表
		$.ajax({
			type: "GET",
			url: "/role/list",
			async: false, //强制同步
			success: function (res) {
				if (res.status) {
					var options = '';
					res.data.forEach(function (item) {
						options += `<option value="${item.id}">${item.name}</option>`;
					});
					$('select[name=role]').html(options);
				}
			}
		})
		// 获取个人资料
		$.ajax({
			type: "GET",
			url: '/admin/info',
			data: { id: id },
			async: false, //强制同步
			success: function (res) {
				if (res.status) {
					// 还原表单
					$('input[name=username]').val(res.data.username);
					$('input[name=fullname]').val(res.data.fullname);
					$(`input[name=sex][value=${res.data.sex}]`).prop('checked', true);
					$('input[name=tel]').val(res.data.tel);
					$('input[name=email]').val(res.data.email);
					$('select[name=role]').val(res.data.role);
					// 还原头像
					$('.upload-box .photo').attr('src', res.data.avatar);
					// 隐藏表单
					$('input[name=avatar]').val(res.data.avatar);
				}
			}
		});
		// 头像上传
		$('.file').change(function () {
			// 提取File对象
			var avatar = $(this)[0].files[0];
			// FormData
			var formData = new FormData();
			// 追加数据
			formData.append('file', avatar);
			formData.append('type', 'avatar');
			// ajax
			$.ajax({
				type: "POST",
				url: "/upload/common/",
				processData: false, //data项传参不转化
				contentType: false, //不设置content-type
				data: formData,
				success: function (res) {
					if (res.status) {
						// 信息提示
						layer.msg(res.msg, { icon: 1 });
						// 显示预览图
						$('.upload-box .photo').attr('src', res.src);
						// 切换plus加号
						$('.upload-box').addClass('uploaded');
						// 隐藏表单
						$('input[name=avatar]').val(res.src);
					}
				},
				statusCode: {
					400: function (res) {
						layer.msg(res.responseJSON.msg, { icon: 2 });
					}
				},
				complete: function () {
					// 无论成功/失败，清空value
					$('.file').val('');
				}
			});
		});
		// 删除头像
		$('.remove').click(function () {
			// 获取当前头像地址
			var url = $(this).parent().prev('.photo').attr('src');
			// 默认头像，不做物理删除
			if (url.includes('default')) {
				$('.upload-box').removeClass('uploaded');
				// 隐藏表单
				$('input[name=avatar]').val('');
				return false;
			}
			// 不是默认头像，物理删除
			$.post('/upload/remove', { src: url }, function (res) {
				if (res.status) {
					// 提示信息
					layer.msg(res.msg, { icon: 1 });
					// 显示plus加号
					$('.upload-box').removeClass('uploaded');
					// 隐藏表单
					$('input[name=avatar]').val('');
				} else {
					layer.msg(res.msg, { icon: 5 });
				}
			});
		});
	</script>

</body>

</html>