<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" type="text/css" href="./assets/lib/bootstrap/css/bootstrap.min.css" />
	<link rel="stylesheet" href="./assets/lib/Validform/css/style.css">
	<link rel="stylesheet" href="./assets/iconfonts/bootstrap-icons.css">
	<link rel="stylesheet" type="text/css" href="./assets/css/style.css" />
	<title>分类列表</title>
</head>

<body>
	<!-- 导航 -->
	<header></header>
	<div class="container-fluid pt-3">
		<div class="row">
			<!-- 侧边栏 -->
			<div id="left-menu" class="col-2 p-0"></div>
			<!-- 内容 -->
			<div class="col-10">
				<div class="card shadow-sm">
					<div class="card-header d-flex justify-content-between">
						<span>分类列表</span>
						<button data-bs-toggle="modal" data-bs-target="#insertModal" type="button"
							class="btn btn-outline-primary btn-sm">
							<i class="bi bi-node-plus"></i>
							添加新分类
						</button>
					</div>
					<div class="card-body">
						<table class="table table-bordered table-hover mb-0 bg-white">
							<thead class="table-light">
								<tr>
									<th scope="col">#</th>
									<th scope="col">分类名称</th>
									<th scope="col">父级分类</th>
									<th scope="col">父级ID</th>
									<th scope="col">操作</th>
								</tr>
							</thead>
							<tbody>
								<!-- <tr>
									<td>1</td>
									<td>前端</td>
									<td>编程</td>
									<td>1</td>
									<td>
										<button type="button" class="btn btn-outline-primary btn-sm">
											<i class="bi bi-pencil-square"></i>
											编辑
										</button>
										<button type="button" class="btn btn-outline-danger btn-sm">
											<i class="bi bi-trash"></i>
											删除
										</button>
									</td>
								</tr> -->
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 添加Modal -->
	<div id="insertModal" class="modal fade" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">添加分类</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<form action="/category/add">
					<div class="modal-body">
						<div class="row mb-4">
							<label class="col-sm-2 col-form-label">分类名称</label>
							<div class="col-sm-10">
								<input name="name" datatype="s2-15" errormsg="分类名称至少2个字符，最多15个字符！" type="text"
									class="form-control">
							</div>
						</div>
						<div class="row mb-4">
							<label class="col-sm-2 col-form-label">父级分类</label>
							<div class="col-sm-10">
								<select datatype="*" name="parent_id" class="form-select">
								</select>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
						<button type="submit" class="btn btn-primary">添加</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- 编辑Modal -->
	<div id="editModal" class="modal fade" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">编辑分类</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<form action="/category/edit">
					<div class="modal-body">
						<!-- 隐藏表单 -->
						<input type="hidden" name="id" value="">
						<div class="row mb-4">
							<label class="col-sm-2 col-form-label">分类名称</label>
							<div class="col-sm-10">
								<input name="name" datatype="s2-15" errormsg="分类名称至少2个字符，最多15个字符！" type="text"
									class="form-control">
							</div>
						</div>
						<div class="row mb-4">
							<label class="col-sm-2 col-form-label">父级分类</label>
							<div class="col-sm-10">
								<select datatype="*" name="parent_id" class="form-select">
								</select>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
						<button type="submit" class="btn btn-primary">保存</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="./assets/lib/jQuery/jquery-3.6.0.min.js"></script>
	<script src="./assets/lib/bootstrap/js/bootstrap.min.js"></script>
	<script src="./assets/lib/layer/layer.js"></script>
	<script src="./assets/lib/Validform/js/Validform_v5.3.2_min.js"></script>
	<!-- 公共layout -->
	<script src="./assets/js/layout.js"></script>
	<!-- 身份认证 -->
	<script src="./assets/js/auth.js"></script>
	<script>
		// 加载分类列表
		function loadList() {
			$.getJSON('/category/list', function (res) {
				if (res.status) {
					var html = '';
					res.data.forEach(function (item) {
						html += `
								<tr>
									<td>${item.id}</td>
									<td>${item.name}</td>
									<td>${item.parent_name || '无'}</td>
									<td>${item.parent_id}</td>
									<td>
										<button type="button" class="btn btn-outline-primary btn-sm edit">
											<i class="bi bi-pencil-square"></i>
											编辑
										</button>
										<button data-id="${item.id}" type="button" class="btn btn-outline-danger btn-sm remove">
											<i class="bi bi-trash"></i>
											删除
										</button>
									</td>
								</tr>`
					});
					$('.table tbody').html(html);
				}
			});
		}
		loadList();
	</script>
	<script>
		// 获取一级分类
		$.getJSON('/category/sub', { id: 0 }, function (res) {
			if (res.status) {
				var options = '<option value="0">无</option>';
				res.data.forEach(function (item) {
					options += `<option value="${item.id}">${item.name}</option>`
				});
				$('select[name=parent_id]').html(options);
			}
		});
		// 获取insertModal实例
		var insertModal = new bootstrap.Modal(document.getElementById('insertModal'));
		// 添加分类--表单验证
		$('#insertModal form').Validform({
			ajaxPost: true,
			tiptype: 4,
			callback: function (res) {
				if (res.status) {
					// 关闭模态框
					insertModal.hide();
					// 提示信息
					layer.msg(res.msg, { icon: 1 });
					// 操作DOM
					loadList();
				} else {
					// 提示信息
					layer.msg(res.msg, { icon: 5 });
				}
			}
		});
	</script>
	<script>
		// 获取editModal实例
		var editModal = new bootstrap.Modal(document.getElementById('editModal'));
		// 打开edit模态框
		$('.table').on('click', '.edit', function () {
			// 提取当前tr的数据
			var $td = $(this).parents('tr').children('td');
			var id = $td.eq(0).text().trim();
			var name = $td.eq(1).text().trim();
			var parent_id = $td.eq(3).text().trim();
			// 还原表单
			$('#editModal input[name=name]').val(name);
			$('#editModal select[name=parent_id]').val(parent_id);
			// 隐藏表单
			$('#editModal input[name=id]').val(id);
			editModal.show();
		});
		// 修改分类--表单验证
		$('#editModal form').Validform({
			ajaxPost: true,
			tiptype: 4,
			callback: function (res) {
				if (res.status) {
					// 关闭模态框
					editModal.hide();
					// 提示信息
					layer.msg(res.msg, { icon: 1 });
					// 操作DOM
					loadList();
				} else {
					// 提示信息
					layer.msg(res.msg, { icon: 5 });
				}
			}
		});
	</script>
	<script>
		// 删除操作---事件委托
		$('.table').on('click', '.remove', function () {
			// 提取id
			var id = $(this).data('id');
			var $tr = $(this).parents('tr');

			layer.confirm('确定要删除此分类吗？', function yes() {
				$.post('/category/remove', { id: id }, function (res) {
					if (res.status) {
						// 删除DOM
						$tr.remove();
						// 提示信息
						layer.msg(res.msg, { icon: 1 });
					} else {
						layer.msg(res.msg, { icon: 5 });
					}
				});
			}, function cancel() {
				layer.msg('取消成功！')
			});
		});
	</script>
</body>

</html>