<!doctype html>
<html lang="en">

	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" type="text/css" href="./assets/lib/bootstrap-4.6.0/css/bootstrap.min.css" />
		<link rel="stylesheet" href="./assets/lib/Validform/css/style.css">
		<link rel="stylesheet" type="text/css" href="./assets/css/style.css" />
		<title>账户编辑</title>
	</head>

	<body>
		<!-- 导航 -->
		<header></header>
		<div class="container-fluid pt-3">
			<div class="row">
				<!-- 侧边栏 -->
				<div id="left-menu" class="col-2 p-0"></div>
				<!-- 内容 -->
				<div class="col-10">
					<div class="card shadow-sm">
						<div class="card-header">
							账户编辑
						</div>
						<div class="card-body">
							<form class="form" action="/admin/info">
								<!-- 隐藏表单 -->
								<input type="hidden" name="id" value="">

								<div class="form-group row">
									<label class="col-sm-2 col-form-label">用户名</label>
									<div class="col-sm-10">
										<input name="username" readonly type="text" class="form-control">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-2 col-form-label">姓名</label>
									<div class="col-sm-10">
										<input name="fullname" datatype="s2-15" errormsg="姓名应该2-15个字符" type="text"
											class="form-control">
									</div>
								</div>
								<div class="form-group row align-items-center">
									<label class="col-sm-2 col-form-label">性别</label>
									<div class="col-sm-10">
										<div class="form-check form-check-inline">
											<label class="form-check-label">
												<input class="form-check-input" type="radio" name="sex" value="男"> 男
											</label>
										</div>
										<div class="form-check form-check-inline">
											<label class="form-check-label">
												<input datatype="*" class="form-check-input" type="radio" name="sex"
													value="女"> 女
											</label>
										</div>
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-2 col-form-label">手机</label>
									<div class="col-sm-10">
										<input name="tel" datatype="m" errormsg="请输入正确的手机号码!" type="text"
											class="form-control">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-2 col-form-label">邮箱</label>
									<div class="col-sm-10">
										<input name="email" datatype="e" errormsg="请输入正确的电子邮箱地址!" type="text"
											class="form-control">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-2 col-form-label">头像</label>
									<div class="col-sm-10">
										<!-- 上传组件 -->
										<div class="upload-box uploaded">
											<div class="plus">
												<svg class="bi" width="60" height="60" fill="currentColor">
													<use xlink:href="./assets/iconfonts/bootstrap-icons.svg#plus" />
												</svg>
												<input type="file" accept="image/*">
											</div>
											<img class="photo" src="">
											<div class="cover">
												<svg class="bi" width="20" height="20" fill="currentColor">
													<use xlink:href="./assets/iconfonts/bootstrap-icons.svg#trash" />
												</svg>
											</div>
										</div>
										<!-- 隐藏表单 -->
										<input datatype="*" type="hidden" name="avatar" value="" />
									</div>
								</div>
								<div class="form-group row">
									<div class="col-sm-10 offset-sm-2">
										<button type="submit" class="btn btn-primary">保存修改</button>
									</div>
								</div>
							</form>
						</div>

					</div>
				</div>
			</div>
		</div>
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="./assets/lib/jQuery/jquery-3.6.0.min.js"></script>
		<script src="./assets/lib/bootstrap-4.6.0/js/bootstrap.min.js"></script>
		<script src="./assets/lib/layer/layer.js"></script>
		<script src="./assets/lib/Validform/js/Validform_v5.3.2_min.js"></script>
		<script src="./assets/js/layout.js"></script>
		<script src="./assets/js/public.js"></script>
		<script type="text/javascript">
			$(document).ready(function() {
				// 获取地址中的参数
				var uid = GetRequest().id;
				// 赋值隐藏表单
				$('input[name=id]').val(uid);
				// 获取uid对应的账户资料
				$.getJSON('/admin/info', { id: uid }, function(res) {
					if (res.status) {
						// 赋值表单
						$('input[name=username]').val(res.data.username);
						$('input[name=fullname]').val(res.data.fullname);
						// 性别
						$('input[name=sex]').each(function() {
							var val = $(this).val()
							if (val == res.data.sex) {
								$(this).prop('checked', true)
							}
						});
						$('input[name=tel]').val(res.data.tel);
						$('input[name=email]').val(res.data.email);
						// 头像
						$('.upload-box .photo').attr('src', res.data.avatar);
						$('input[name=avatar]').val(res.data.avatar);
					}
				});
				// 头像上传
				$('.upload-box .plus input').change(function() {
					// 获取File文件对象：jQ对象 => js对象 
					var file = $(this)[0].files[0];
					// 生成空form
					var formData = new FormData();
					// 添加参数
					formData.append('file', file);
					formData.append('type', 'avatar');
					// ajax发送文件
					$.ajax({
						type: 'POST',
						url: '/upload/common/',
						processData: false,
						contentType: false,
						data: formData,
						success: function(res) {
							layer.msg(res.msg);
							if (res.status) {
								// 显示上传之后的图片
								$('.upload-box').find('.photo').attr('src', res.src);
								$('.upload-box').addClass('uploaded');
								$('input[name=avatar]').val(res.src);
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown) {
							var msg = XMLHttpRequest.responseJSON.msg;
							layer.msg(msg);
						},
						complete: function(XMLHttpRequest, textStatus) {
							$('.upload-box .plus input').val('');
						}
					});
				});
				// 删除头像
				$('.upload-box .cover svg').click(function() {
					var $photo = $(this).parent().siblings('.photo');
					var path = $photo.attr('src');
					// 检测是否默认头像
					var isDefault = path.indexOf('default') >= 0;
					// 默认头像，不做物理删除
					if (isDefault) {
						$photo.attr('src', '');
						$('input[name=avatar]').val('');
						$('.upload-box').removeClass('uploaded');
						return;
					}
					// 不是默认头像，物理删除图片
					$.ajax({
						type: "POST",
						url: "/upload",
						data: { src: path },
						success: function(res) {
							layer.msg(res.msg);
							if (res.status) {
								$photo.attr('src', '');
								$('input[name=avatar]').val('');
								$('.upload-box').removeClass('uploaded');
							}
						}
					});
				});

				// 保存修改
				$('.form').Validform({
					tiptype: 4,
					ajaxPost: true,
					callback: function(res) {
						layer.msg(res.msg);
					}
				});
				// 页面即将离开，检测表单是否完整
				$(window).on('beforeunload', function(e) {
					e.preventDefault();
					e.returnValue = '';
					return false;
				});

			});
		</script>
	</body>

</html>
